<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„Ø°ÙƒÙŠ - Ù…Ù†ØµØ© Ø¬Ø§Ù‡Ø²Ø©</title>

<!-- Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª -->
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>

<style>
body{font-family:Segoe UI, sans-serif;background:#f5f6fa;padding:20px;text-align:center;color:#333}
.card{max-width:800px;margin:auto;background:#fff;padding:30px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.1)}
input[type=file], button, input[type=range]{width:100%;margin:10px 0;padding:12px;font-size:16px;border-radius:8px;border:1px solid #ccc}
button{background:#d35400;color:#fff;border:none;cursor:pointer;transition:0.3s}
button:hover{background:#e67e22}
.preview{margin-top:20px;text-align:right;max-height:400px;overflow:auto;padding:10px;border:1px solid #ddd;border-radius:10px;background:#fafafa}
.range-label{margin-top:10px;font-size:14px;color:#555}
</style>
</head>
<body>

<div class="card">
<h2>ğŸ“ Ù…Ù†ØµØ© ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ©</h2>
<p>Ù‚Ù… Ø¨Ø±ÙØ¹ Ù‚Ø§Ù„Ø¨ PDF ÙˆÙ‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Excel) Ø«Ù… Ø§Ø¶ØºØ· Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª</p>

<input type="file" id="pdfInput" accept=".pdf">
<input type="file" id="excelInput" accept=".xlsx,.xls">

<div class="range-label">â¬‡ï¸ Ø¶Ø¨Ø· Ø§Ù„Ø¥Ø²Ø§Ø­Ø© Ø§Ù„Ø±Ø£Ø³ÙŠØ© (Ù…Ø¹Ø§ÙŠÙ†Ø©)</div>
<input type="range" id="yOffset" min="0" max="200" value="0">
<div>Ø§Ù„Ù‚ÙŠÙ…Ø©: <span id="yVal">0</span></div>

<button onclick="start()">ğŸš€ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª</button>

<div id="result" class="preview"></div>
</div>

<script>
const ySlider = document.getElementById("yOffset");
const yVal = document.getElementById("yVal");
const pdfInput = document.getElementById("pdfInput");
const excelInput = document.getElementById("excelInput");
const result = document.getElementById("result");

ySlider.oninput = () => yVal.innerText = ySlider.value;

// ØªØ­ÙˆÙŠÙ„ Ù…Ù… Ø¥Ù„Ù‰ Ù†Ù‚Ø§Ø· PDF
function mm2pt(mm) { return mm * 72 / 25.4; }

// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù„ÙƒÙ„ Ø¹Ù†ØµØ± (Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§)
const elementSettingsMM = {
    name:     { x: 105, y: 150, fontMM: 10 },
    trainer:  { x: 20,  y: 120, fontMM: 6 },
    hours:    { x: 20,  y: 100, fontMM: 6 },
    date:     { x: 20,  y: 80,  fontMM: 6 },
    serial:   { x: 150, y: 120, fontMM: 6 }
};

async function start() {
    const pdfFile = pdfInput.files[0];
    const excelFile = excelInput.files[0];
    if (!pdfFile || !excelFile) return alert("Ø§Ø®ØªØ± Ø§Ù„Ù…Ù„ÙØ§Øª Ø£ÙˆÙ„Ø§Ù‹");

    result.innerHTML = "<p>â³ Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª...</p>";

    const basePdf = await pdfFile.arrayBuffer();
    const reader = new FileReader();

    reader.onload = async e => {
        const wb = XLSX.read(new Uint8Array(e.target.result), { type: "array" });
        const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });

        if (rows.length <= 1) {
            result.innerHTML = "<p>âš ï¸ Ù…Ù„Ù Excel ÙØ§Ø±Øº Ø£Ùˆ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª</p>";
            return;
        }

        const zip = new JSZip();
        result.innerHTML = ""; // Ù…Ø³Ø­ Ø§Ù„Ø±Ø³Ø§Ù„Ø©

        for (let i = 1; i < rows.length; i++) {
            const row = rows[i];

            if (!row[0]) {
                console.warn(`ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ØµÙ ${i+1} Ù„Ø£Ù†Ù‡ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ø³Ù…`);
                continue;
            }

            const data = {
                name: row[0],
                trainer: row[1] || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯",
                hours: row[2] || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯",
                date: row[3] || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯",
                serial: row[0]
            };

            const pdfBytes = await makePDF(basePdf, data);

            zip.file(`Ø´Ù‡Ø§Ø¯Ø©_${data.name}.pdf`, pdfBytes);

            const url = URL.createObjectURL(new Blob([pdfBytes], { type: "application/pdf" }));
            const div = document.createElement("div");
            div.style.marginBottom = "8px";
            div.innerHTML = `ğŸ‘¤ <strong>${data.name}</strong> | 
                <a href="${url}" target="_blank">Ù…Ø¹Ø§ÙŠÙ†Ø©</a> | 
                <a href="${url}" download="Ø´Ù‡Ø§Ø¯Ø©_${data.name}.pdf">ØªØ­Ù…ÙŠÙ„</a>`;
            result.appendChild(div);
        }

        // Ø¥Ø¶Ø§ÙØ© Ø±Ø§Ø¨Ø· ØªÙ†Ø²ÙŠÙ„ ZIP
        const content = await zip.generateAsync({ type: "blob" });
        const zipUrl = URL.createObjectURL(content);
        const zipDiv = document.createElement("div");
        zipDiv.style.marginTop = "15px";
        zipDiv.innerHTML = `<strong>â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©:</strong> 
            <a href="${zipUrl}" download="ÙƒÙ„_Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª.zip">ZIP</a>`;
        result.appendChild(zipDiv);
    };

    reader.readAsArrayBuffer(excelFile);
}

async function makePDF(bytes, data) {
    const { PDFDocument, StandardFonts, rgb } = PDFLib;

    const pdf = await PDFDocument.load(bytes);
    const page = pdf.getPages()[0];
    const { width, height } = page.getSize();
    const offset = Number(ySlider.value);
    const font = await pdf.embedFont(StandardFonts.TimesRomanBold);

    function drawElement(el, text) {
        const fontSize = mm2pt(el.fontMM);
        page.drawText(text, {
            x: mm2pt(el.x),
            y: height - mm2pt(el.y) - offset,
            size: fontSize,
            font,
            color: rgb(0,0,0)
        });
    }

    drawElement(elementSettingsMM.name, data.name);
    drawElement(elementSettingsMM.trainer, `Ø§Ù„Ù…Ø¯Ø±Ø¨: ${data.trainer}`);
    drawElement(elementSettingsMM.hours, `Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø§Ø¹Ø§Øª: ${data.hours}`);
    drawElement(elementSettingsMM.date, `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${data.date}`);
    drawElement(elementSettingsMM.serial, `Serial: ${data.serial}`);

    return await pdf.save();
}
</script>

</body>
</html>
