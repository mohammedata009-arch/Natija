<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù†Ø¸Ø§Ù… Ø¯Ù…Ø¬ Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø°ÙƒÙŠ</title>
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f9; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        .sidebar { width: 320px; background: #fff; padding: 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.1); overflow-y: auto; z-index: 10; }
        .viewer { flex: 1; background: #525659; display: flex; justify-content: center; overflow: auto; padding: 40px; position: relative; }
        canvas { box-shadow: 0 0 20px rgba(0,0,0,0.5); cursor: crosshair; background: white; }
        .step { background: #eef2f7; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-right: 4px solid #1a73e8; }
        h2 { font-size: 18px; color: #1a73e8; margin-top: 0; }
        .coord-item { font-size: 12px; background: #fff; padding: 5px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px; }
        button { width: 100%; padding: 12px; background: #1a73e8; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        button:disabled { background: #ccc; }
        .tool-select { width: 100%; padding: 8px; margin-bottom: 10px; border-radius: 5px; }
        #status { font-weight: bold; color: green; margin-top: 10px; text-align: center; }
    </style>
</head>
<body>

<div class="sidebar">
    <h2>ğŸ› ï¸ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù‚Ø§Ù„Ø¨ ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>
    
    <div class="step">
        <label>1. Ø§Ø±ÙØ¹ Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„ÙØ§Ø±Øº (PDF)</label>
        <input type="file" id="pdfInput" accept=".pdf" style="width: 100%">
    </div>

    <div class="step">
        <label>2. Ø­Ø¯Ø¯ Ø§Ù„Ø¹Ù†ØµØ± Ø«Ù… Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø§Ù„Ø¨</label>
        <select id="currentTool" class="tool-select">
            <option value="trainee">Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¯Ø±Ø¨</option>
            <option value="course">Ø§Ø³Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</option>
            <option value="date">Ø§Ù„ØªØ§Ø±ÙŠØ®</option>
            <option value="serial">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ</option>
            <option value="sign">Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ (ØµÙˆØ±Ø©)</option>
        </select>
        <div id="coordsDisplay"></div>
    </div>

    <div class="step">
        <label>3. Ø§Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ (Ø¨ÙŠØ§Ù†Ø§Øª)</label>
        <input type="file" id="excelInput" accept=".xlsx, .xls" style="width: 100%">
    </div>

    <div class="step">
        <label>4. Ø§Ø±ÙØ¹ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ (PNG Ø´ÙØ§Ù)</label>
        <input type="file" id="signInput" accept="image/png" style="width: 100%">
    </div>

    <button id="generateBtn" onclick="generateBatch()" disabled>Ø¥ØµØ¯Ø§Ø± ÙƒØ§ÙØ© Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª (PDF)</button>
    <div id="status"></div>
</div>

<div class="viewer">
    <canvas id="pdfCanvas"></canvas>
</div>

<script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    
    let locations = {};
    let excelData = [];
    let pdfDocGlobal = null;
    let templateBytes = null;
    let signImgBytes = null;
    let originalViewport = null;

    const canvas = document.getElementById('pdfCanvas');
    const ctx = canvas.getContext('2d');

    // ØªØ­Ù…ÙŠÙ„ ÙˆÙ…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù€ PDF
    document.getElementById('pdfInput').onchange = async (e) => {
        const file = e.target.files[0];
        templateBytes = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(templateBytes.slice(0)).promise;
        const page = await pdf.getPage(1);
        originalViewport = page.getViewport({ scale: 1.0 });
        const viewport = page.getViewport({ scale: 1.5 });
        
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        await page.render({ canvasContext: ctx, viewport: viewport }).promise;
        document.getElementById('status').innerText = "âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ù„Ø¨. Ø­Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¢Ù†.";
    };

    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø¨Ø§Ù„Ù†Ù‚Ø±
    canvas.onmousedown = (e) => {
        if (!originalViewport) return;
        const rect = canvas.getBoundingClientRect();
        const xCanvas = (e.clientX - rect.left) * (canvas.width / rect.width);
        const yCanvas = (e.clientY - rect.top) * (canvas.height / rect.height);

        // ØªØ­ÙˆÙŠÙ„ Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª PDF Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
        const pdfX = (xCanvas / canvas.width) * originalViewport.width;
        const pdfY = originalViewport.height - ((yCanvas / canvas.height) * originalViewport.height);

        const tool = document.getElementById('currentTool').value;
        locations[tool] = { x: pdfX, y: pdfY };
        
        updateCoordsUI();
        drawMarker(xCanvas, yCanvas, tool);
    };

    function updateCoordsUI() {
        const disp = document.getElementById('coordsDisplay');
        disp.innerHTML = Object.entries(locations).map(([k, v]) => 
            `<div class="coord-item">ğŸ“ ${k}: X=${v.x.toFixed(1)}, Y=${v.y.toFixed(1)}</div>`
        ).join('');
    }

    function drawMarker(x, y, label) {
        ctx.fillStyle = 'red';
        ctx.beginPath();
        ctx.arc(x, y, 5, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillText(label, x + 10, y);
    }

    // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¥ÙƒØ³Ù„
    document.getElementById('excelInput').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = (ev) => {
            const data = new Uint8Array(ev.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            excelData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1}).slice(1);
            document.getElementById('status').innerText = `ğŸ“Š ØªÙ… ØªØ­Ù…ÙŠÙ„ ${excelData.length} Ø³Ø¬Ù„.`;
            document.getElementById('generateBtn').disabled = false;
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    };

    document.getElementById('signInput').onchange = async (e) => {
        signImgBytes = await e.target.files[0].arrayBuffer();
    };

    // ØªÙˆÙ„ÙŠØ¯ PDF Ù…Ø¯Ù…Ø¬
    async function generateBatch() {
        if (!locations.trainee) return alert("ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¯Ø±Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„");
        
        document.getElementById('status').innerText = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆÙ„ÙŠØ¯...";
        const { PDFDocument, rgb } = PDFLib;
        const mainPdf = await PDFDocument.create();
        const templateDoc = await PDFDocument.load(templateBytes);
        
        let embeddedSign = null;
        if (signImgBytes) embeddedSign = await mainPdf.embedPng(signImgBytes);

        const limit = Math.min(excelData.length, 100);

        for (let i = 0; i < limit; i++) {
            const row = excelData[i];
            const [copiedPage] = await mainPdf.copyPages(templateDoc, [0]);
            const page = mainPdf.addPage(copiedPage);

            // ÙˆØ¶Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
            if (locations.trainee && row[0]) 
                page.drawText(String(row[0]), { x: locations.trainee.x, y: locations.trainee.y, size: 24 });
            
            if (locations.course && row[1]) 
                page.drawText(String(row[1]), { x: locations.course.x, y: locations.course.y, size: 20 });
            
            if (locations.date && row[2]) 
                page.drawText(String(row[2]), { x: locations.date.x, y: locations.date.y, size: 14 });

            if (locations.serial && row[3]) 
                page.drawText(String(row[3]), { x: locations.serial.x, y: locations.serial.y, size: 12 });

            if (locations.sign && embeddedSign) 
                page.drawImage(embeddedSign, { x: locations.sign.x, y: locations.sign.y, width: 100, height: 50 });
        }

        const pdfBytes = await mainPdf.save();
        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = "Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª_Ø§Ù„Ù…Ø¬Ù…Ø¹Ø©.pdf";
        link.click();
        document.getElementById('status').innerText = "âœ… Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„!";
    }
</script>

</body>
</html>

