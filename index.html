<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„Ø°ÙƒÙŠ 2026</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body{
font-family:Segoe UI;
background:#f0f4f8;
padding:20px;
display:flex;
flex-direction:column;
align-items:center
}
.panel{
background:#fff;
padding:20px;
border-radius:15px;
box-shadow:0 4px 20px rgba(0,0,0,.1);
max-width:750px;
width:100%
}
.section{
background:#f9fbff;
padding:15px;
border-radius:10px;
border:1px solid #d6e4f0;
margin-bottom:15px
}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
label{font-weight:bold}
input,select{
width:100%;
padding:10px;
border-radius:8px;
border:1px solid #bcccdc
}
button{
padding:15px;
background:#004494;
color:#fff;
border:none;
border-radius:8px;
font-size:16px;
cursor:pointer
}
button:hover{background:#003371}
#log{text-align:center;margin:10px;font-weight:bold}
.canvas-container{
border:4px solid #004494;
margin-top:15px;
background:#fff;
overflow:auto
}
#previewArea{
display:grid;
grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
gap:12px;
margin-top:20px
}
.preview-box{
background:#fff;
padding:8px;
border-radius:10px;
box-shadow:0 3px 10px rgba(0,0,0,.1)
}
.preview-box img{
width:100%;
border-radius:8px
}
</style>
</head>

<body>

<div class="panel">
<h2 style="text-align:center">ğŸ“ Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„Ø°ÙƒÙŠ</h2>

<div class="section">
<label>Ø§Ù„Ù‚Ø§Ù„Ø¨ ÙˆØ§Ù„ØªÙˆÙ‚ÙŠØ¹</label>
<div class="grid">
<input type="file" id="bgInput" accept="image/*">
<input type="file" id="signInput" accept="image/*">
</div>
</div>

<div class="section">
<label>Ù…Ù„Ù Excel</label>
<input type="file" id="excelInput" accept=".xls,.xlsx">
</div>

<div class="section">
<label>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙƒØªØ§Ø¨Ø©</label>
<div class="grid">
<select id="currentTool">
<option value="trainee">Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¯Ø±Ø¨ (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ)</option>
<option value="trainer">Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø¨</option>
<option value="course">Ø§Ø³Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</option>
<option value="date">Ø§Ù„ØªØ§Ø±ÙŠØ®</option>
<option value="serial">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ</option>
<option value="signature">Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</option>
</select>
<input type="number" id="fSize" value="50">
</div>
<input type="color" id="fColor" value="#002d72">
</div>

<div id="log">Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„â€¦</div>
<button onclick="generateCertificates()">Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª ğŸ‘€</button>
</div>

<div class="canvas-container">
<canvas id="mainCanvas"></canvas>
</div>

<h3 style="margin-top:25px">ğŸ“¸ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª</h3>
<div id="previewArea"></div>

<script>
const canvas=document.getElementById("mainCanvas");
const ctx=canvas.getContext("2d");

let bgImg=new Image();
let signImg=new Image();
let excelData=[];
let locations={};

function log(msg,ok=false){
const l=document.getElementById("log");
l.style.color=ok?"green":"#d32f2f";
l.innerText=msg;
}

/* ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ± */
function loadImage(input,img,isBg){
if(!input.files[0])return;
const r=new FileReader();
r.onload=e=>{
img.onload=()=>{
if(isBg){
canvas.width=img.width;
canvas.height=img.height;
drawPreview();
log("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ù„Ø¨",true);
}
}
img.src=e.target.result;
}
r.readAsDataURL(input.files[0]);
}

bgInput.onchange=()=>loadImage(bgInput,bgImg,true);
signInput.onchange=()=>loadImage(signInput,signImg,false);

/* Ù‚Ø±Ø§Ø¡Ø© Excel */
excelInput.onchange=e=>{
const r=new FileReader();
r.onload=ev=>{
const wb=XLSX.read(new Uint8Array(ev.target.result),{type:"array"});
const rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1});
excelData=rows.slice(1).filter(r=>r[0]).map(r=>({
trainee:r[0],
trainer:r[1]||"",
course:r[2]||"",
date:r[3]||""
}));
log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${excelData.length} Ø§Ø³Ù…`,true);
}
r.readAsArrayBuffer(e.target.files[0]);
};

/* ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ */
canvas.addEventListener("mousedown",e=>{
if(!bgImg.src){log("âŒ Ø­Ù…Ù‘Ù„ Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø£ÙˆÙ„Ø§Ù‹");return;}
const rect=canvas.getBoundingClientRect();
const tool=currentTool.value;
locations[tool]={
x:(e.clientX-rect.left)*(canvas.width/rect.width),
y:(e.clientY-rect.top)*(canvas.height/rect.height),
size:+fSize.value,
color:fColor.value
};
drawPreview();
log("ğŸ“ ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆØ¶Ø¹",true);
});

/* Ù…Ø¹Ø§ÙŠÙ†Ø© */
function drawPreview(){
ctx.clearRect(0,0,canvas.width,canvas.height);
ctx.drawImage(bgImg,0,0);
ctx.fillStyle="rgba(255,0,0,.7)";
Object.values(locations).forEach(l=>{
ctx.beginPath();
ctx.arc(l.x,l.y,8,0,Math.PI*2);
ctx.fill();
});
}

/* ØªØ­Ù‚Ù‚ Ø°ÙƒÙŠ */
function validate(){
if(!bgImg.src) return "âŒ Ù„Ù… ÙŠØªÙ… Ø±ÙØ¹ Ø§Ù„Ù‚Ø§Ù„Ø¨";
if(excelData.length===0) return "âŒ Ù„Ù… ÙŠØªÙ… Ø±ÙØ¹ Excel";
if(!locations.trainee) return "âŒ Ø­Ø¯Ø¯ Ù…ÙƒØ§Ù† Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¯Ø±Ø¨";
return null;
}

/* ØªÙˆÙ„ÙŠØ¯ + Ù…Ø¹Ø§ÙŠÙ†Ø© */
async function generateCertificates(){
const err=validate();
if(err){log(err);return;}

previewArea.innerHTML="";
const {jsPDF}=window.jspdf;

excelData.forEach((row,i)=>{
ctx.clearRect(0,0,canvas.width,canvas.height);
ctx.drawImage(bgImg,0,0);

const data={
trainee:row.trainee,
trainer:row.trainer,
course:row.course,
date:row.date,
serial:String(i+1).padStart(3,"0")
};

Object.entries(locations).forEach(([k,l])=>{
if(k==="signature" && signImg.src){
const w=canvas.width*.15;
const h=w*(signImg.height/signImg.width);
ctx.drawImage(signImg,l.x-w/2,l.y-h/2,w,h);
}else if(data[k]){
ctx.fillStyle=l.color;
ctx.font=`bold ${l.size}px Arial`;
ctx.textAlign="center";
ctx.fillText(data[k],l.x,l.y);
}
});

const img=new Image();
img.src=canvas.toDataURL("image/jpeg",0.9);

const btn=document.createElement("button");
btn.innerText="ØªØ­Ù…ÙŠÙ„ PDF";
btn.onclick=()=>{
const pdf=new jsPDF({
orientation:canvas.width>canvas.height?"l":"p",
unit:"px",
format:[canvas.width,canvas.height]
});
pdf.addImage(img.src,"JPEG",0,0);
pdf.save(`Ø´Ù‡Ø§Ø¯Ø©_${row.trainee}.pdf`);
};

const box=document.createElement("div");
box.className="preview-box";
box.appendChild(img);
box.appendChild(btn);

previewArea.appendChild(box);
});

log("ğŸ‘€ ØªÙ…Øª Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© â€“ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¢Ù†",true);
}
</script>

</body>
</html>
