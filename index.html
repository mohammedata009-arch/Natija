<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù†Ø¸Ø§Ù… PDF Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…Ø·ÙˆÙ‘Ø± 2026</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
:root { --primary:#0056b3; --accent:#28a745; }
body { font-family:'Segoe UI', sans-serif; background:#f4f7f9; padding:20px; text-align:center; }
.container { max-width:1000px; margin:auto; background:white; padding:25px; border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,0.1); }
.upload-section { display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:20px; }
.file-box { border:2px dashed #ccc; padding:15px; border-radius:10px; transition:0.3s; }
.file-box:hover { border-color:var(--primary); background:#f0f7ff; }
button { background:var(--primary); color:white; border:none; padding:12px 25px; border-radius:8px; cursor:pointer; font-size:16px; margin:5px; }
button:disabled { background:#ccc; cursor:not-allowed; }
#status { margin:15px; font-weight:bold; color:var(--primary); }
canvas { max-width:100%; border:1px solid #ddd; margin-top:10px; display:none; }
.detected-fields { margin-top:15px; text-align:right; background:#eee; padding:10px; border-radius:8px; }
#dataEditor { margin-top:20px; overflow:auto; max-height:300px; }
table { border-collapse:collapse; width:100%; }
td, th { border:1px solid #999; padding:5px; text-align:center; min-width:80px; }
input { width:100%; box-sizing:border-box; text-align:center; }
</style>
</head>

<body>
<div class="container">
<h2>ğŸ§  Ù†Ø¸Ø§Ù… PDF Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…Ø·ÙˆÙ‘Ø±</h2>
<p>Ø±ÙØ¹ Ù†Ø³Ø®Ø© ÙØ§Ø±ØºØ© ÙˆÙ†Ø³Ø®Ø© Ù…Ù„ÙŠØ¦Ø© Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø­Ù‚ÙˆÙ„ØŒ Ø£Ùˆ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Ù…Ø­Ø±Ø± Ø§Ù„Ø¬Ø¯ÙˆÙ„.</p>

<div class="upload-section">
<div class="file-box">
<label>1. PDF ÙØ§Ø±Øº (Ø§Ù„Ù‚Ø§Ù„Ø¨)</label>
<input type="file" id="pdfEmpty" accept=".pdf">
</div>
<div class="file-box">
<label>2. PDF Ù…Ù„ÙŠØ¡ (Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©)</label>
<input type="file" id="pdfFull" accept=".pdf">
</div>
</div>

<div class="file-box" style="margin-bottom:20px;">
<label>3. Excel Ø¬Ø¯ÙŠØ¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ø¥Ø°Ø§ Ù„Ù… ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ø±Ø±)</label>
<input type="file" id="excelInput" accept=".xlsx,.xls">
</div>

<button id="analyzeBtn" onclick="analyzePDFs()">ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª ÙˆØ§ÙƒØªØ´Ø§Ù Ø§Ù„Ø­Ù‚ÙˆÙ„ ğŸ”</button>
<button id="generateBtn" onclick="generateNewPDFs()" disabled>Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ğŸ“„</button>

<div id="status">Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…...</div>

<div id="results" style="display:none;">
<h3>Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù…ÙƒØªØ´ÙØ©:</h3>
<div id="fieldsList" class="detected-fields"></div>
<canvas id="diffCanvas"></canvas>
</div>

<h3>ğŸ“ Ù…Ø­Ø±Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø±ÙØ¹ Excel)</h3>
<div id="dataEditor">
<table id="dataTable">
<tr>
<th>Ø§Ø³Ù…</th><th>Ù…Ø¯Ø±Ø¨</th><th>Ø¨Ø±Ù†Ø§Ù…Ø¬</th><th>ØªØ§Ø±ÙŠØ®</th>
</tr>
<tr>
<td><input type="text"></td>
<td><input type="text"></td>
<td><input type="text"></td>
<td><input type="text"></td>
</tr>
</table>
<button onclick="addRow()">â• Ø¥Ø¶Ø§ÙØ© ØµÙ</button>
<button onclick="addColumn()">â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯</button>
</div>

</div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
let detectedLocations=[], excelData=[], originalPdfBytes;

function updateStatus(msg,isOk=false){const s=document.getElementById('status'); s.innerText=msg; s.style.color=isOk?"green":"var(--primary)";}

// ØªØ­ÙˆÙŠÙ„ PDF Ø¥Ù„Ù‰ Canvas
async function pdfToCanvas(file){
  const arr=await file.arrayBuffer();
  const pdf=await pdfjsLib.getDocument(arr).promise;
  const page=await pdf.getPage(1);
  const vp=page.getViewport({scale:1.5});
  const cv=document.createElement('canvas'); cv.width=vp.width; cv.height=vp.height;
  await page.render({canvasContext:cv.getContext('2d'),viewport:vp}).promise;
  return cv;
}

// ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª
async function analyzePDFs(){
  const emptyFile=document.getElementById('pdfEmpty').files[0];
  const fullFile=document.getElementById('pdfFull').files[0];
  if(!emptyFile||!fullFile)return alert("Ø§Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙÙŠÙ†!");
  updateStatus("â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...");
  const canvasE=await pdfToCanvas(emptyFile);
  const canvasF=await pdfToCanvas(fullFile);
  const ctxE=canvasE.getContext('2d'), ctxF=canvasF.getContext('2d');
  const w=canvasE.width, h=canvasE.height;
  const imgE=ctxE.getImageData(0,0,w,h).data;
  const imgF=ctxF.getImageData(0,0,w,h).data;
  let diffPoints=[];
  for(let i=0;i<imgF.length;i+=4){
    if((imgE[i]+imgE[i+1]+imgE[i+2])-(imgF[i]+imgF[i+1]+imgF[i+2])>180){
      const idx=i/4; diffPoints.push({x:idx%w,y:Math.floor(idx/w)});
    }
  }
  detectedLocations=clusterPoints(diffPoints);
  showPreview(canvasE,detectedLocations);
  updateStatus(`âœ… Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„! ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${detectedLocations.length} Ø­Ù‚Ù„.`,true);
  document.getElementById('generateBtn').disabled=false;
  originalPdfBytes=await emptyFile.arrayBuffer();
}

function clusterPoints(points){
  let clusters=[];
  points.forEach(p=>{
    let found=clusters.find(c=>Math.abs(c.x-p.x)<60 && Math.abs(c.y-p.y)<25);
    if(!found)clusters.push({x:p.x,y:p.y});
  });
  return clusters.sort((a,b)=>(Math.abs(a.y-b.y)>10?a.y-b.y:a.x-b.x));
}

function showPreview(canvas,locations){
  const resDiv=document.getElementById('results');
  const listDiv=document.getElementById('fieldsList');
  const dCanvas=document.getElementById('diffCanvas');
  resDiv.style.display='block'; dCanvas.style.display='block';
  dCanvas.width=canvas.width; dCanvas.height=canvas.height;
  const ctx=dCanvas.getContext('2d'); ctx.drawImage(canvas,0,0);
  listDiv.innerHTML="";
  locations.forEach((loc,i)=>{
    ctx.strokeStyle="red"; ctx.lineWidth=3; ctx.strokeRect(loc.x-50,loc.y-15,100,30);
    ctx.fillStyle="red"; ctx.fillText(i+1,loc.x,loc.y-20);
    listDiv.innerHTML+=`ğŸ“ Ø­Ù‚Ù„ ${i+1}: Ù…Ø±ØªØ¨Ø· Ø¨Ø¹Ù…ÙˆØ¯ Ø±Ù‚Ù… ${i+1}<br>`;
  });
}

// Ù‚Ø±Ø§Ø¡Ø© Excel
excelInput.onchange=e=>{
  const r=new FileReader();
  r.onload=ev=>{
    const wb=XLSX.read(new Uint8Array(ev.target.result),{type:"array"});
    excelData=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1}).slice(1);
    updateStatus(`ğŸ“Š ØªÙ… ØªØ­Ù…ÙŠÙ„ ${excelData.length} Ø³Ø¬Ù„ Ù…Ù† Ø§Ù„Ø¥ÙƒØ³Ù„`);
  };
  r.readAsArrayBuffer(e.target.files[0]);
};

// Ù…Ø­Ø±Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
function addRow(){
  const table=document.getElementById('dataTable');
  const row=table.insertRow();
  for(let i=0;i<table.rows[0].cells.length;i++){
    const cell=row.insertCell();
    const input=document.createElement('input'); input.type='text'; cell.appendChild(input);
  }
}
function addColumn(){
  const table=document.getElementById('dataTable');
  for(let i=0;i<table.rows.length;i++){
    const cell=table.rows[i].insertCell();
    const input=document.createElement('input'); input.type='text'; cell.appendChild(input);
  }
}
function readTableData(){
  const table=document.getElementById('dataTable');
  const data=[];
  for(let r=1;r<table.rows.length;r++){
    const row=[];
    for(let c=0;c<table.rows[r].cells.length;c++){
      row.push(table.rows[r].cells[c].querySelector('input').value);
    }
    data.push(row);
  }
  return data;
}

// Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„ÙØ§Øª PDF Ø¬Ø¯ÙŠØ¯Ø©
async function generateNewPDFs(){
  let rows=excelData.length?excelData:readTableData();
  if(!rows.length) return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª!");
  updateStatus("â³ Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„ÙØ§Øª...");
  const {PDFDocument,rgb}=PDFLib;
  const canvasW=document.getElementById('diffCanvas').width;
  const canvasH=document.getElementById('diffCanvas').height;
  for(let row of rows){
    const pdfDoc=await PDFDocument.load(originalPdfBytes);
    const pages=pdfDoc.getPages();
    const page=pages[0];
    const {width,height}=page.getSize();
    detectedLocations.forEach((loc,i)=>{
      if(row[i]){
        const pdfX=(loc.x/canvasW)*width;
        const pdfY=height-((loc.y/canvasH)*height);
        page.drawText(String(row[i]),{
          x:pdfX-30,
          y:pdfY,
          size:14,
          color:rgb(0,0,0.5)
        });
      }
    });
    const pdfBytes=await pdfDoc.save();
    const blob=new Blob([pdfBytes],{type:"application/pdf"});
    const link=document.createElement('a');
    link.href=URL.createObjectURL(blob);
    link.download=`Document_${row[0]||"new"}.pdf`;
    link.click();
  }
  updateStatus("âœ… ØªÙ… Ø¥ØµØ¯Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª!",true);
}
</script>
</body>
</html>
