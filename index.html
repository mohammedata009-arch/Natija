<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„Ø°ÙƒÙŠ</title>

<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body{font-family:Segoe UI;background:#f5f6fa;padding:20px;text-align:center}
.card{max-width:700px;margin:auto;background:#fff;padding:30px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.1)}
input,button{width:100%;margin:10px 0;padding:12px}
button{background:#d35400;color:#fff;border:none;border-radius:8px;font-size:18px;cursor:pointer}
.preview{margin-top:20px;text-align:right}
</style>
</head>
<body>

<div class="card">
<h2>ğŸ“ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ù…Ù† Excel</h2>

<input type="file" id="pdfInput" accept=".pdf">
<input type="file" id="excelInput" accept=".xlsx,.xls">

<label>â¬‡ï¸ Ø¶Ø¨Ø· Ø§Ù„Ø¥Ø²Ø§Ø­Ø© Ø§Ù„Ø±Ø£Ø³ÙŠØ© (Ù…Ø¹Ø§ÙŠÙ†Ø©)</label>
<input type="range" id="yOffset" min="0" max="200" value="0">
<div>Ø§Ù„Ù‚ÙŠÙ…Ø©: <span id="yVal">0</span></div>

<button onclick="start()">ğŸš€ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª</button>

<div id="result" class="preview"></div>
</div>

<script>
const ySlider = document.getElementById("yOffset");
const yVal = document.getElementById("yVal");
const pdfInput = document.getElementById("pdfInput");
const excelInput = document.getElementById("excelInput");
const result = document.getElementById("result");

ySlider.oninput = () => yVal.innerText = ySlider.value;

// ØªØ­ÙˆÙŠÙ„ Ù…Ù… Ø¥Ù„Ù‰ Ù†Ù‚Ø§Ø· PDF
function mm2pt(mm) {
    return mm * 72 / 25.4;
}

// ==================== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¨Ø§Ù„Ù…Ù„Ù„ÙŠÙ…ØªØ± ====================
const elementSettingsMM = {
    name:     { x: 105, y: 150, fontMM: 10 }, // Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨
    trainer:  { x: 20,  y: 120, fontMM: 6 },  // Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø¨
    hours:    { x: 20,  y: 100, fontMM: 6 },  // Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø§Ø¹Ø§Øª
    date:     { x: 20,  y: 80,  fontMM: 6 },  // Ø§Ù„ØªØ§Ø±ÙŠØ®
    serial:   { x: 150, y: 120, fontMM: 6 }   // Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ
};

async function start() {
    const pdfFile = pdfInput.files[0];
    const excelFile = excelInput.files[0];
    if (!pdfFile || !excelFile) return alert("Ø§Ø®ØªØ± Ø§Ù„Ù…Ù„ÙØ§Øª");

    const basePdf = await pdfFile.arrayBuffer();

    const reader = new FileReader();
    reader.onload = async e => {
        const wb = XLSX.read(new Uint8Array(e.target.result), { type: "array" });
        const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });
        
        for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            if (!row[0]) continue;

            const data = {
                name: row[0],
                trainer: row[1] || "",
                hours: row[2] || "",
                date: row[3] || "",
                serial: row[0]
            };

            await makePDF(basePdf, data);
        }
    };
    reader.readAsArrayBuffer(excelFile);
}

async function makePDF(bytes, data) {
    const { PDFDocument, StandardFonts, rgb } = PDFLib;
    const pdf = await PDFDocument.load(bytes);
    const page = pdf.getPages()[0];
    const { width, height } = page.getSize();
    const offset = Number(ySlider.value);

    const font = await pdf.embedFont(StandardFonts.TimesRomanBold);

    function drawElement(el, text) {
        const fontSize = mm2pt(el.fontMM);
        page.drawText(text, {
            x: mm2pt(el.x),
            y: height - mm2pt(el.y) - offset,
            size: fontSize,
            font,
            color: rgb(0,0,0)
        });
    }

    drawElement(elementSettingsMM.name, data.name);
    drawElement(elementSettingsMM.trainer, `Ø§Ù„Ù…Ø¯Ø±Ø¨: ${data.trainer}`);
    drawElement(elementSettingsMM.hours, `Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø§Ø¹Ø§Øª: ${data.hours}`);
    drawElement(elementSettingsMM.date, `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${data.date}`);
    drawElement(elementSettingsMM.serial, `Serial: ${data.serial}`);

    const out = await pdf.save();
    const url = URL.createObjectURL(new Blob([out], { type: "application/pdf" }));

    const div = document.createElement("div");
    div.innerHTML = `ğŸ‘¤ ${data.name} | 
        <a href="${url}" target="_blank">Ù…Ø¹Ø§ÙŠÙ†Ø©</a> | 
        <a href="${url}" download="Ø´Ù‡Ø§Ø¯Ø©_${data.name}.pdf">ØªØ­Ù…ÙŠÙ„</a>`;
    result.appendChild(div);
}
</script>

</body>
</html>
