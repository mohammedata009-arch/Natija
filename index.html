<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù†Ø¸Ø§Ù… Ø¯Ù…Ø¬ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„Ø°ÙƒÙŠ 2026</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root { --primary: #1a73e8; --bg: #f8f9fa; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .header { text-align: center; margin-bottom: 30px; }
        .upload-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .drop-zone { border: 2px dashed #dadce0; padding: 20px; border-radius: 10px; text-align: center; transition: 0.3s; background: #fff; }
        .drop-zone:hover { border-color: var(--primary); background: #f1f8ff; }
        .drop-zone label { display: block; font-weight: bold; margin-bottom: 10px; color: var(--primary); }
        button { background: var(--primary); color: white; border: none; padding: 12px 25px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 500; transition: 0.3s; }
        button:hover { background: #1557b0; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #log { margin-top: 20px; padding: 15px; border-radius: 6px; font-weight: 500; text-align: center; }
        .canvas-wrapper { margin-top: 20px; overflow: auto; border: 1px solid #eee; border-radius: 8px; max-height: 500px; display: none; }
        canvas { display: block; margin: auto; }
        .info-tag { font-size: 12px; color: #666; margin-top: 5px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ğŸ“ Ù…Ø­Ø±Ùƒ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„Ø°ÙƒÙŠ (Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ØµØ±ÙŠ)</h1>
        <p>Ù‚Ø§Ø±Ù† Ø¨ÙŠÙ† Ù…Ù„ÙÙŠÙ† PDF ÙˆØ§Ø³ØªØ®Ø±Ø¬ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ø¯Ù…Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª Excel</p>
    </div>

    <div class="upload-grid">
        <div class="drop-zone">
            <label>1. Ù…Ù„Ù PDF ÙØ§Ø±Øº</label>
            <input type="file" id="pdfEmpty" accept=".pdf">
            <div class="info-tag">Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø°ÙŠ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡</div>
        </div>
        <div class="drop-zone">
            <label>2. Ù…Ù„Ù PDF Ù…Ø¹Ø¨Ø£ (Ù…Ø«Ø§Ù„)</label>
            <input type="file" id="pdfFull" accept=".pdf">
            <div class="info-tag">ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©</div>
        </div>
        <div class="drop-zone">
            <label>3. Ù…Ù„Ù Excel</label>
            <input type="file" id="excelInput" accept=".xlsx, .xls">
            <div class="info-tag">ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†</div>
        </div>
    </div>

    <div style="text-align: center; border-top: 1px solid #eee; pt-20px; padding-top: 20px;">
        <button id="analyzeBtn" onclick="processAnalysis()">ØªØ­Ù„ÙŠÙ„ ÙˆÙ…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù†Ø³Ø® ğŸ”</button>
        <button id="generateBtn" onclick="generateFinalPDF()" disabled>ØªÙˆÙ„ÙŠØ¯ ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø¯Ù…Ø¬ ğŸ“„</button>
    </div>

    <div id="log">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª...</div>

    <div class="canvas-wrapper" id="canvasWrapper">
        <h3 style="text-align:center">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ­Ù„ÙŠÙ„ (Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù…ÙƒØªØ´ÙØ©)</h3>
        <canvas id="previewCanvas"></canvas>
    </div>
</div>

<script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    let detectedPoints = [];
    let excelRows = [];
    let templateBytes;

    function log(msg, type = 'info') {
        const el = document.getElementById('log');
        el.innerText = msg;
        el.style.color = type === 'error' ? '#d93025' : (type === 'success' ? '#188038' : '#1a73e8');
    }

    // 1. ØªØ­ÙˆÙŠÙ„ PDF Ù„Ù€ Canvas
    async function pdfToCanvas(file) {
        const data = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(data).promise;
        const page = await pdf.getPage(1);
        const viewport = page.getViewport({ scale: 1.0 }); // Ø³ÙƒÙ‘ÙŠÙ„ 1 Ù„Ù„Ø³Ø±Ø¹Ø©
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        await page.render({ canvasContext: ctx, viewport: viewport }).promise;
        return canvas;
    }

    // 2. Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ Ø¨Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© (Ø§Ù„Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø§Ù„Ù…Ø³Ø±Ø¹Ø©)
    async function processAnalysis() {
        const f1 = document.getElementById('pdfEmpty').files[0];
        const f2 = document.getElementById('pdfFull').files[0];

        if (!f1 || !f2) return log("âŒ ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙÙŠÙ† Ø§Ù„ÙØ§Ø±Øº ÙˆØ§Ù„Ù…Ù„ÙŠØ¡ Ø£ÙˆÙ„Ø§Ù‹", "error");

        log("â³ Ø¬Ø§Ø±ÙŠ Ø³Ø­Ø¨ Ø§Ù„Ø¨ÙƒØ³Ù„Ø§Øª ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ...");
        
        try {
            const canvasE = await pdfToCanvas(f1);
            const canvasF = await pdfToCanvas(f2);
            
            const w = canvasE.width;
            const h = canvasE.height;
            const imgE = canvasE.getContext('2d').getImageData(0,0,w,h).data;
            const imgF = canvasF.getContext('2d').getImageData(0,0,w,h).data;

            let points = [];
            // Ø§Ù„Ù‚ÙØ² (Stride) Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠØ© Ø¨Ù…Ù‚Ø¯Ø§Ø± 16 Ù…Ø±Ø©
            for (let y = 0; y < h; y += 4) {
                for (let x = 0; x < w; x += 4) {
                    const i = (y * w + x) * 4;
                    // Ø·Ø±Ø­ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø± (ÙƒØ§ÙÙŠØ© Ù„Ù„Ø§ÙƒØªØ´Ø§Ù)
                    if (Math.abs(imgE[i] - imgF[i]) > 70) {
                        points.push({x, y});
                    }
                }
            }

            // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ù‚Ø§Ø· (Clustering)
            detectedPoints = [];
            points.forEach(p => {
                let existing = detectedPoints.find(dp => Math.abs(dp.x - p.x) < 50 && Math.abs(dp.y - p.y) < 20);
                if (!existing) detectedPoints.push({x: p.x, y: p.y});
            });

            // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ù†Ø·Ù‚ÙŠØ§Ù‹: Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ù„Ø£Ø³ÙÙ„ Ø«Ù… ÙŠÙ…ÙŠÙ† Ù„ÙŠØ³Ø§Ø±
            detectedPoints.sort((a, b) => (Math.abs(a.y - b.y) > 15 ? a.y - b.y : b.x - a.x));

            visualize(canvasE);
            templateBytes = await f1.arrayBuffer();
            document.getElementById('generateBtn').disabled = false;
            log(`âœ… ØªÙ… Ø§ÙƒØªØ´Ø§Ù ${detectedPoints.length} Ø­Ù‚ÙˆÙ„. Ø§Ø±ÙØ¹ Ø§Ù„Ø¥ÙƒØ³Ù„ Ø«Ù… Ø§Ø¶ØºØ· ØªÙˆÙ„ÙŠØ¯.`, "success");

        } catch (err) {
            log("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„: " + err.message, "error");
        }
    }

    function visualize(baseCanvas) {
        const wrapper = document.getElementById('canvasWrapper');
        const mainCanvas = document.getElementById('previewCanvas');
        wrapper.style.display = 'block';
        mainCanvas.width = baseCanvas.width;
        mainCanvas.height = baseCanvas.height;
        const ctx = mainCanvas.getContext('2d');
        ctx.drawImage(baseCanvas, 0, 0);
        
        ctx.fillStyle = "rgba(26, 115, 232, 0.2)";
        ctx.strokeStyle = "#1a73e8";
        ctx.font = "bold 16px Arial";

        detectedPoints.forEach((p, i) => {
            ctx.strokeRect(p.x - 40, p.y - 15, 80, 25);
            ctx.fillText(i + 1, p.x, p.y - 20);
        });
    }

    // 3. Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¥ÙƒØ³Ù„
    document.getElementById('excelInput').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = (ev) => {
            const data = new Uint8Array(ev.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            excelRows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1}).slice(1);
            log(`ğŸ“Š ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¥ÙƒØ³Ù„ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ${excelRows.length} Ø³Ø¬Ù„`, "success");
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    };

    // 4. ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø¯Ù…Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
    async function generateFinalPDF() {
        if (excelRows.length === 0) return log("âŒ ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ Ø£ÙˆÙ„Ø§Ù‹", "error");
        log("â³ Ø¬Ø§Ø±ÙŠ Ø¨Ù†Ø§Ø¡ Ù…Ù„Ù Ø§Ù„Ù€ PDF Ø§Ù„Ù…Ø¯Ù…Ø¬...");

        const { PDFDocument, rgb } = PDFLib;
        const mainPdf = await PDFDocument.create();
        const templateDoc = await PDFDocument.load(templateBytes);

        for (const row of excelRows) {
            const [copiedPage] = await mainPdf.copyPages(templateDoc, [0]);
            const page = mainPdf.addPage(copiedPage);
            const { width, height } = page.getSize();
            const canvasW = document.getElementById('previewCanvas').width;
            const canvasH = document.getElementById('previewCanvas').height;

            detectedPoints.forEach((p, i) => {
                if (row[i]) {
                    // ØªØ­ÙˆÙŠÙ„ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ Ø¥Ù„Ù‰ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª PDF Ù…Ø¹ Ù…Ø±Ø§Ø¹Ø§Ø© Ù‚Ù„Ø¨ Ø§Ù„Ù…Ø­ÙˆØ± Y
                    const pdfX = (p.x / canvasW) * width;
                    const pdfY = height - ((p.y / canvasH) * height);
                    
                    // ØªØ­Ø³ÙŠÙ† Ø¨Ø³ÙŠØ·: Ø¹ÙƒØ³ Ø§Ù„Ù†Øµ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙÙŠ PDF-Lib
                    const text = String(row[i]); 
                    
                    page.drawText(text, {
                        x: pdfX - (text.length * 3), // Ù…Ø­Ø§Ø°Ø§Ø© ØªÙ‚Ø±ÙŠØ¨ÙŠØ©
                        y: pdfY,
                        size: 14,
                        color: rgb(0, 0, 0)
                    });
                }
            });
        }

        const mergedBytes = await mainPdf.save();
        const blob = new Blob([mergedBytes], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª_Ø§Ù„Ù…Ø¯Ù…Ø¬Ø©_2026.pdf";
        a.click();
        log("âœ… Ø§ÙƒØªÙ…Ù„Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©! ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù.", "success");
    }
</script>

</body>
</html>

