<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù…Ø³ØªØ®Ø±Ø¬ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª PDF Ø¨Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ©</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #1a1a1a; color: white; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        .toolbar { background: #2d2d2d; padding: 15px; display: flex; gap: 15px; align-items: center; border-bottom: 2px solid var(--primary); box-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .main-content { flex: 1; overflow: auto; display: flex; justify-content: center; background: #404040; padding: 20px; position: relative; }
        canvas { border: 2px solid #fff; box-shadow: 0 0 20px rgba(0,0,0,0.8); cursor: crosshair; }
        .sidebar { width: 300px; background: #2d2d2d; padding: 20px; border-right: 1px solid #444; overflow-y: auto; }
        input[type="file"] { background: #444; padding: 5px; border-radius: 5px; color: white; }
        .coord-card { background: #3d3d3d; padding: 10px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #007bff; animation: slideIn 0.3s; }
        button { background: #007bff; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        @keyframes slideIn { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body>

<div class="toolbar">
    <strong>ğŸ› ï¸ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª PDF:</strong>
    <input type="file" id="pdfUpload" accept=".pdf">
    <span id="pageInfo">ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ Ù…Ù„Ù...</span>
    <button onclick="clearCoords()">Ù…Ø³Ø­ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª</button>
</div>

<div style="display: flex; flex: 1; overflow: hidden;">
    <div class="sidebar">
        <h3>ğŸ“ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø©</h3>
        <p style="font-size: 12px; color: #aaa;">(Ù‡Ø°Ù‡ Ø§Ù„Ù‚ÙŠÙ… Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ Ø¨Ø±Ù…Ø¬Ø© PDF-Lib)</p>
        <div id="coordsList"></div>
    </div>
    
    <div class="main-content" id="container">
        <canvas id="pdfCanvas"></canvas>
    </div>
</div>

<script>
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    let pdfDoc = null;
    let originalViewport = null;
    const canvas = document.getElementById('pdfCanvas');
    const ctx = canvas.getContext('2d');

    // 1. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù€ PDF Ø¨Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ©
    document.getElementById('pdfUpload').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const arrayBuffer = await file.arrayBuffer();
        pdfDoc = await pdfjsLib.getDocument(arrayBuffer).promise;
        renderPage(1);
    });

    async function renderPage(num) {
        const page = await pdfDoc.getPage(num);
        
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Scale Ø¹Ø§Ù„ÙŠ (2.0) Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¹Ø§Ù„ÙŠØ© Ø¬Ø¯Ø§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ø±Ø¤ÙŠØ©
        const viewport = page.getViewport({ scale: 2.0 });
        originalViewport = page.getViewport({ scale: 1.0 }); // Ø§Ù„Ù…Ù‚ÙŠØ§Ø³ Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ Ù„Ù„Ù€ PDF

        canvas.height = viewport.height;
        canvas.width = viewport.width;

        const renderContext = {
            canvasContext: ctx,
            viewport: viewport
        };
        await page.render(renderContext).promise;
        document.getElementById('pageInfo').innerText = `Ø§Ù„ØµÙØ­Ø© 1 Ù…Ù† ${pdfDoc.numPages} | Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ© (200%)`;
    }

    // 2. Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø±
    canvas.addEventListener('mousedown', function(e) {
        if (!pdfDoc) return;

        const rect = canvas.getBoundingClientRect();
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ¶Ø¹ Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ù„ÙƒØ§Ù†ÙØ§Ø³ (Ø¨ÙƒØ³Ù„Ø§Øª Ø§Ù„Ø´Ø§Ø´Ø©)
        const xCanvas = (e.clientX - rect.left) * (canvas.width / rect.width);
        const yCanvas = (e.clientY - rect.top) * (canvas.height / rect.height);

        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…ÙˆØ¶Ø¹ Ø¥Ù„Ù‰ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª PDF Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© (Points)
        // ÙÙŠ PDF: Ù†Ù‚Ø·Ø© Ø§Ù„Ø£ØµÙ„ (0,0) Ù‡ÙŠ Ø£Ø³ÙÙ„ Ø§Ù„ÙŠØ³Ø§Ø±
        const pdfX = (xCanvas / canvas.width) * originalViewport.width;
        const pdfY = originalViewport.height - ((yCanvas / canvas.height) * originalViewport.height);

        addCoordToList(pdfX.toFixed(2), pdfY.toFixed(2));
        drawMarker(xCanvas, yCanvas);
    });

    function addCoordToList(x, y) {
        const list = document.getElementById('coordsList');
        const div = document.createElement('div');
        div.className = 'coord-card';
        div.innerHTML = `
            <strong>Ø­Ù‚Ù„ ${list.children.length + 1}</strong><br>
            X: <code>${x}</code> | Y: <code>${y}</code>
        `;
        list.prepend(div);
    }

    function drawMarker(x, y) {
        ctx.beginPath();
        ctx.arc(x, y, 8, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(255, 0, 0, 0.7)';
        ctx.fill();
        ctx.strokeStyle = 'white';
        ctx.lineWidth = 2;
        ctx.stroke();
    }

    function clearCoords() {
        document.getElementById('coordsList').innerHTML = '';
        if (pdfDoc) renderPage(1);
    }
</script>

</body>
</html>

