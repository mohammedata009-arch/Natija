<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ¹Ø¯ÙŠÙ„ Ù…Ù„ÙØ§Øª PDF ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</title>
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #e74c3c; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f4f7f6; padding: 20px; text-align: center; }
        .container { max-width: 700px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .upload-section { border: 2px dashed #3498db; padding: 20px; border-radius: 10px; margin-bottom: 20px; background: #ebf5fb; }
        input[type="file"] { margin: 10px 0; width: 100%; }
        .btn { background: var(--primary); color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-size: 18px; width: 100%; transition: 0.3s; }
        .btn:hover { background: #34495e; }
        #status { margin-top: 15px; font-weight: bold; color: #2980b9; }
        .preview-list { margin-top: 20px; text-align: right; }
        .download-item { display: flex; justify-content: space-between; align-items: center; background: #fff; padding: 10px; border: 1px solid #ddd; margin-bottom: 5px; border-radius: 5px; }
        .download-link { background: #27ae60; color: white; text-decoration: none; padding: 5px 15px; border-radius: 4px; font-size: 14px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ“„ Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø¨Ù…Ù„Ù PDF Ø§Ù„Ø£ØµÙ„ÙŠ</h2>
    <p>Ù‚Ù… Ø¨Ø±ÙØ¹ Ù‚Ø§Ù„Ø¨ PDF ÙˆÙ…Ù„Ù Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ØŒ ÙˆØ³ÙŠØªÙ… Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙˆÙ‚ Ø§Ù„Ù…Ù„Ù Ø¨Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ©.</p>

    <div class="upload-section">
        <label>1. Ù…Ù„Ù Ø§Ù„Ù‚Ø§Ù„Ø¨ (PDF):</label>
        <input type="file" id="pdfInput" accept=".pdf">
        
        <label>2. Ù…Ù„Ù Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ (Excel):</label>
        <input type="file" id="excelInput" accept=".xlsx, .xls">
    </div>

    <button class="btn" onclick="processPDFs()">ØªÙˆÙ„ÙŠØ¯ Ù…Ù„ÙØ§Øª PDF ÙˆØ§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©</button>
    
    <div id="status"></div>
    <div id="downloadArea" class="preview-list"></div>
</div>

<script>
    async function processPDFs() {
        const pdfFile = document.getElementById('pdfInput').files[0];
        const excelFile = document.getElementById('excelInput').files[0];
        const status = document.getElementById('status');
        const downloadArea = document.getElementById('downloadArea');

        if (!pdfFile || !excelFile) {
            alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù PDF ÙˆÙ…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„");
            return;
        }

        status.innerText = "Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„ÙØ§Øª...";
        downloadArea.innerHTML = "";

        // Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„Ù€ PDF ÙƒÙ€ ArrayBuffer
        const pdfBytes = await pdfFile.arrayBuffer();

        // Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„
        const reader = new FileReader();
        reader.onload = async function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1});
            
            // Ø³Ø­Ø¨ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ (Ø£ÙˆÙ„ 3 Ø£Ø³Ù…Ø§Ø¡ Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†)
            const names = rows.slice(1, 4).map(r => r[0]);

            for (let name of names) {
                if (!name) continue;
                await createSinglePDF(pdfBytes, name.toString().toUpperCase());
            }
            status.innerText = "ØªÙ…Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨Ù†Ø¬Ø§Ø­! âœ…";
        };
        reader.readAsArrayBuffer(excelFile);
    }

    async function createSinglePDF(existingPdfBytes, studentName) {
        const { PDFDocument, rgb, StandardFonts } = PDFLib;

        // ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ù€ PDF Ø§Ù„Ø£ØµÙ„ÙŠ
        const pdfDoc = await PDFDocument.load(existingPdfBytes);
        const pages = pdfDoc.getPages();
        const firstPage = pages[0];
        const { width, height } = firstPage.getSize();

        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø· Times Roman Bold (Ù…ØªÙˆÙØ± Ù‚ÙŠØ§Ø³ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ù…ÙƒØªØ¨Ø©)
        const font = await pdfDoc.embedFont(StandardFonts.TimesRomanBold);

        // Ø­Ø³Ø§Ø¨ Ø­Ø¬Ù… Ø§Ù„Ø®Ø· ÙˆØ§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø£Ø¨Ø¹Ø§Ø¯ Ù…Ù„Ù Ø¹Ø¨Ø¯Ø§Ù„ÙØªØ§Ø­
        const fontSize = height * 0.05; 
        const textWidth = font.widthOfTextAtSize(studentName, fontSize);

        // Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª (Ø§Ù„Ù…Ù†ØªØµÙ Ø¹Ø±Ø¶ÙŠØ§Ù‹ØŒ Ùˆ43% Ù…Ù† Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„ Ù„Ø£Ù† Ù†Ø¸Ø§Ù… PDF ÙŠØ¨Ø¯Ø£ Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„)
        const x = (width - textWidth) / 2;
        const y = height * 0.57; // 100% - 43% = 57% Ù„Ø¶Ø¨Ø· Ø§Ù„Ù…ÙƒØ§Ù† Ø¨Ø¯Ù‚Ø©

        // Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙˆÙ‚ Ø§Ù„ØµÙØ­Ø©
        firstPage.drawText(studentName, {
            x: x,
            y: y,
            size: fontSize,
            font: font,
            color: rgb(0, 0, 0),
        });

        // Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù
        const modifiedPdfBytes = await pdfDoc.save();
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· ØªØ­Ù…ÙŠÙ„ ÙˆÙ…Ø¹Ø§ÙŠÙ†Ø©
        const blob = new Blob([modifiedPdfBytes], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        
        const item = document.createElement('div');
        item.className = "download-item";
        item.innerHTML = `
            <span>${studentName}</span>
            <div>
                <a href="${url}" target="_blank" style="margin-left:10px; color:#3498db;">Ù…Ø¹Ø§ÙŠÙ†Ø©</a>
                <a href="${url}" download="Ø´Ù‡Ø§Ø¯Ø©_${studentName}.pdf" class="download-link">ØªØ­Ù…ÙŠÙ„ PDF</a>
            </div>
        `;
        document.getElementById('downloadArea').appendChild(item);
    }
</script>

</body>
</html>

