<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…ÙˆÙ„Ø¯ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØµØ­Ø­</title>
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
<style>
body{font-family:sans-serif;text-align:center;padding:20px;background:#f0f0f0;}
input,button{width:100%;margin:10px 0;padding:10px;font-size:16px;}
button{background:#d35400;color:#fff;border:none;cursor:pointer;}
.preview{margin-top:20px;text-align:right;max-height:600px;overflow:auto;}
iframe{border:1px solid #aaa;border-radius:5px;width:100%;height:200px;}
.status{margin:10px 0;font-weight:bold;color:#555;}
</style>
</head>
<body>

<h2>ğŸ“ Ù…ÙˆÙ„Ø¯ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</h2>
<input type="file" id="pdfInput" accept=".pdf">
<input type="file" id="excelInput" accept=".xlsx,.xls">
<button onclick="start()">ğŸš€ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª</button>

<div id="status" class="status"></div>
<div id="result" class="preview"></div>

<script>
const pdfInput = document.getElementById("pdfInput");
const excelInput = document.getElementById("excelInput");
const result = document.getElementById("result");
const status = document.getElementById("status");

function mm2pt(mm){ return mm*72/25.4; }

async function start(){
    if(!pdfInput.files[0]||!excelInput.files[0]) return alert("Ø§Ø®ØªØ± Ø§Ù„Ù…Ù„ÙØ§Øª Ø£ÙˆÙ„Ø§Ù‹");
    result.innerHTML=""; status.innerHTML="â³ Ø¬Ø§Ø±ÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©...";
    const basePdf = await pdfInput.files[0].arrayBuffer();
    const reader = new FileReader();
    reader.onload = async e=>{
        const wb = XLSX.read(new Uint8Array(e.target.result), {type:"array"});
        const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
        if(rows.length<=1){ status.innerHTML="âš ï¸ Excel ÙØ§Ø±Øº"; return; }
        const zip = new JSZip();

        for(let i=1;i<rows.length;i++){
            const row = rows[i];
            if(!row[0]) continue; // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ØµÙÙˆÙ Ø§Ù„ÙØ§Ø±ØºØ©
            const data={
                name: row[0],
                trainer: row[1]||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯",
                hours: row[2]||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯",
                date: row[3]||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯",
                serial: row[0]
            };

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¯ÙˆÙ† Ù…Ø³Ø­ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø§Øª
            status.innerHTML=`â³ Ø¥Ù†Ø´Ø§Ø¡ Ø´Ù‡Ø§Ø¯Ø© ${i} Ù…Ù† ${rows.length-1}: ${data.name}`;

            const pdfBytes = await makePDF(basePdf,data);
            const safeName = data.name.replace(/[^a-z0-9_\-Ø¡-ÙŠ ]/gi,'');

            // Ø¥Ø¶Ø§ÙØ© PDF Ø¥Ù„Ù‰ ZIP
            zip.file(`Ø´Ù‡Ø§Ø¯Ø©_${safeName}.pdf`, pdfBytes);

            // Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙÙˆØ±ÙŠØ©
            const url = URL.createObjectURL(new Blob([pdfBytes], {type:"application/pdf"}));
            const div = document.createElement("div");
            div.style.marginBottom="15px";
            div.innerHTML = `<strong>${data.name}</strong><br>
                             <iframe src="${url}"></iframe><br>
                             <a href="${url}" download="Ø´Ù‡Ø§Ø¯Ø©_${safeName}.pdf">ØªØ­Ù…ÙŠÙ„ PDF</a>`;
            result.appendChild(div);
        }

        // Ø±Ø§Ø¨Ø· ZIP Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª
        const content = await zip.generateAsync({type:"blob"});
        const zipUrl = URL.createObjectURL(content);
        const zipDiv = document.createElement("div");
        zipDiv.style.marginTop="15px";
        zipDiv.innerHTML=`â¬‡ï¸ <a href="${zipUrl}" download="ÙƒÙ„_Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª.zip">ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª ZIP</a>`;
        result.appendChild(zipDiv);

        status.innerHTML="âœ… ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡!";
    };
    reader.readAsArrayBuffer(excelInput.files[0]);
}

// Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ PDF Ù„ÙƒÙ„ Ø´Ø®Øµ
async function makePDF(bytes,data){
    const {PDFDocument,StandardFonts,rgb} = PDFLib;
    const pdf = await PDFDocument.load(bytes);
    const page = pdf.getPages()[0];
    const font = await pdf.embedFont(StandardFonts.TimesRomanBold);
    const {width,height} = page.getSize();

    const drawText = (text,x,y,size)=>{
        page.drawText(text,{
            x:mm2pt(x),
            y:height-mm2pt(y),
            font,
            size,
            color:rgb(0,0,0)
        });
    };

    drawText(data.name,105,150,12);
    drawText("Ø§Ù„Ù…Ø¯Ø±Ø¨: "+data.trainer,20,120,8);
    drawText("Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø§Ø¹Ø§Øª: "+data.hours,20,100,8);
    drawText("Ø§Ù„ØªØ§Ø±ÙŠØ®: "+data.date,20,80,8);
    drawText("Serial: "+data.serial,150,120,8);

    return await pdf.save();
}
</script>

</body>
</html>
