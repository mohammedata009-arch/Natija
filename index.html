<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù…Ø³ØªØ®Ø±Ø¬ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª PDF Ø§Ù„Ø°ÙƒÙŠ 2026</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root { --primary: #0056b3; --accent: #28a745; }
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f9; padding: 20px; text-align: center; }
        .container { max-width: 900px; margin: auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .upload-section { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .file-box { border: 2px dashed #ccc; padding: 15px; border-radius: 10px; transition: 0.3s; }
        .file-box:hover { border-color: var(--primary); background: #f0f7ff; }
        button { background: var(--primary); color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-size: 16px; margin: 5px; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #status { margin: 15px; font-weight: bold; color: var(--primary); }
        canvas { max-width: 100%; border: 1px solid #ddd; margin-top: 10px; display: none; }
        .detected-fields { margin-top: 15px; text-align: right; background: #eee; padding: 10px; border-radius: 8px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ§  Ù†Ø¸Ø§Ù… Ø§Ø³ØªÙ†ØªØ§Ø¬ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª PDF Ø§Ù„Ø°ÙƒÙŠ</h2>
    <p>Ù‚Ù… Ø¨Ø±ÙØ¹ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ÙØ§Ø±ØºØ© ÙˆØ§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¹Ø¨Ø£Ø© Ù„ÙŠÙ‚ÙˆÙ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨ØªØ­Ø¯ÙŠØ¯ Ø£Ù…Ø§ÙƒÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</p>

    <div class="upload-section">
        <div class="file-box">
            <label>1. PDF ÙØ§Ø±Øº (Ø§Ù„Ù‚Ø§Ù„Ø¨)</label>
            <input type="file" id="pdfEmpty" accept=".pdf">
        </div>
        <div class="file-box">
            <label>2. PDF Ù…Ù„ÙŠØ¡ (Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©)</label>
            <input type="file" id="pdfFull" accept=".pdf">
        </div>
    </div>

    <div class="file-box" style="margin-bottom: 20px;">
        <label>3. Ù…Ù„Ù Excel (Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)</label>
        <input type="file" id="excelInput" accept=".xlsx, .xls">
    </div>

    <button id="analyzeBtn" onclick="analyzePDFs()">ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª ÙˆØ§ÙƒØªØ´Ø§Ù Ø§Ù„Ø­Ù‚ÙˆÙ„ ğŸ”</button>
    <button id="generateBtn" onclick="generateNewPDFs()" disabled>Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ğŸ“„</button>

    <div id="status">Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…...</div>

    <div id="results" style="display:none;">
        <h3>Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù…ÙƒØªØ´ÙØ© (ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„):</h3>
        <div id="fieldsList" class="detected-fields"></div>
        <canvas id="diffCanvas"></canvas>
    </div>
</div>

<script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    let detectedLocations = [];
    let excelData = [];
    let originalPdfBytes;

    async function analyzePDFs() {
        const emptyFile = document.getElementById('pdfEmpty').files[0];
        const fullFile = document.getElementById('pdfFull').files[0];
        
        if (!emptyFile || !fullFile) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙÙŠÙ† Ù…Ø¹Ø§Ù‹!");

        updateStatus("â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙƒØ³Ù„Ø§Øª... Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ø°Ù„Ùƒ Ø«ÙˆØ§Ù†ÙŠ");

        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙØ­Ø§Øª Ù„ØµÙˆØ±
        const canvasE = await pdfToCanvas(emptyFile);
        const canvasF = await pdfToCanvas(fullFile);
        
        const ctxE = canvasE.getContext('2d');
        const ctxF = canvasF.getContext('2d');
        const width = canvasE.width;
        const height = canvasE.height;

        const imgE = ctxE.getImageData(0, 0, width, height).data;
        const imgF = ctxF.getImageData(0, 0, width, height).data;

        let diffPoints = [];
        for (let i = 0; i < imgF.length; i += 4) {
            // Ø·Ø±Ø­ Ø§Ù„Ø¨ÙƒØ³Ù„Ø§Øª (Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù„ÙŠØ¡ Ø£ØºÙ…Ù‚ Ù…Ù† Ø§Ù„ÙØ§Ø±Øº Ø¨ÙØ±Ù‚ Ù…Ù„Ø­ÙˆØ¸)
            if (imgE[i] - imgF[i] > 60) {
                const pixelIdx = i / 4;
                diffPoints.push({ x: pixelIdx % width, y: Math.floor(pixelIdx / width) });
            }
        }

        // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ù‚Ø§Ø· Ø¥Ù„Ù‰ Ø­Ù‚ÙˆÙ„
        detectedLocations = clusterPoints(diffPoints);
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        showPreview(canvasE, detectedLocations);
        updateStatus(`âœ… Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„! ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${detectedLocations.length} Ø­Ù‚Ù„ Ø¥Ø¯Ø®Ø§Ù„.`, true);
        document.getElementById('generateBtn').disabled = false;
        
        // Ø­ÙØ¸ Ù…Ù„Ù Ø§Ù„Ù€ PDF Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹
        originalPdfBytes = await emptyFile.arrayBuffer();
    }

    async function pdfToCanvas(file) {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
        const page = await pdf.getPage(1);
        const viewport = page.getViewport({ scale: 1.5 });
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        await page.render({ canvasContext: context, viewport: viewport }).promise;
        return canvas;
    }

    function clusterPoints(points) {
        let clusters = [];
        points.forEach(p => {
            let found = clusters.find(c => Math.abs(c.x - p.x) < 60 && Math.abs(c.y - p.y) < 25);
            if (!found) clusters.push({ x: p.x, y: p.y });
        });
        // Ø§Ù„ØªØ±ØªÙŠØ¨: Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ù„Ø£Ø³ÙÙ„ØŒ Ø«Ù… Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† Ù„Ù„ÙŠØ³Ø§Ø± (Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)
        return clusters.sort((a, b) => (Math.abs(a.y - b.y) > 10 ? a.y - b.y : b.x - a.x));
    }

    function showPreview(canvas, locations) {
        const resDiv = document.getElementById('results');
        const listDiv = document.getElementById('fieldsList');
        const dCanvas = document.getElementById('diffCanvas');
        resDiv.style.display = 'block';
        dCanvas.style.display = 'block';
        
        dCanvas.width = canvas.width;
        dCanvas.height = canvas.height;
        const ctx = dCanvas.getContext('2d');
        ctx.drawImage(canvas, 0, 0);
        
        listDiv.innerHTML = "";
        locations.forEach((loc, i) => {
            ctx.strokeStyle = "red";
            ctx.lineWidth = 3;
            ctx.strokeRect(loc.x - 50, loc.y - 15, 100, 30);
            ctx.fillStyle = "red";
            ctx.fillText(i + 1, loc.x, loc.y - 20);
            listDiv.innerHTML += `ğŸ“ Ø­Ù‚Ù„ ${i+1}: Ù…Ø±ØªØ¨Ø· Ø¨Ø¹Ù…ÙˆØ¯ Ø¥ÙƒØ³Ù„ Ø±Ù‚Ù… ${i+1}<br>`;
        });
    }

    // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¥ÙƒØ³Ù„
    excelInput.onchange = e => {
        const reader = new FileReader();
        reader.onload = ev => {
            const wb = XLSX.read(new Uint8Array(ev.target.result), {type: "array"});
            excelData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header: 1}).slice(1);
            updateStatus(`ğŸ“Š ØªÙ… ØªØ­Ù…ÙŠÙ„ ${excelData.length} Ø³Ø¬Ù„ Ù…Ù† Ø§Ù„Ø¥ÙƒØ³Ù„`);
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    };

    async function generateNewPDFs() {
        if (!excelData.length) return alert("Ø§Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ Ø£ÙˆÙ„Ø§Ù‹!");
        updateStatus("â³ Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„ÙØ§Øª PDF...");

        const { PDFDocument, rgb } = PDFLib;

        for (let row of excelData) {
            const pdfDoc = await PDFDocument.load(originalPdfBytes);
            const page = pdfDoc.getPages()[0];
            const { width, height } = page.getSize();
            const canvasW = document.getElementById('diffCanvas').width;
            const canvasH = document.getElementById('diffCanvas').height;

            detectedLocations.forEach((loc, i) => {
                if (row[i]) {
                    // ØªØ­ÙˆÙŠÙ„ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ Ø¥Ù„Ù‰ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª PDF
                    const pdfX = (loc.x / canvasW) * width;
                    const pdfY = height - ((loc.y / canvasH) * height); // PDF ÙŠØ¨Ø¯Ø£ Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„

                    page.drawText(String(row[i]), {
                        x: pdfX - 30, // Ø¥Ø²Ø§Ø­Ø© Ø¨Ø³ÙŠØ·Ø© Ù„Ù„ØªÙˆØ³ÙŠØ·
                        y: pdfY,
                        size: 14,
                        color: rgb(0, 0, 0.5)
                    });
                }
            });

            const pdfBytes = await pdfDoc.save();
            const blob = new Blob([pdfBytes], { type: "application/pdf" });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Document_${row[0]}.pdf`;
            link.click();
        }
        updateStatus("âœ… ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!", true);
    }

    function updateStatus(msg, isOk = false) {
        const s = document.getElementById('status');
        s.innerText = msg;
        s.style.color = isOk ? "green" : "var(--primary)";
    }
</script>
</body>
</html>

